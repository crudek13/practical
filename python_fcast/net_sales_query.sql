WITH T1 AS (
SELECT
    DEPARTMENT,
    BU_ENTITY,
    DEPARTMENT || '_' || BU_ENTITY AS "DEP_ENT",
	DATE_TRUNC('month', TRX_DATE) AS "MONTH", 
	SUM(NET_SALES) AS "NET_SALES"
FROM ANALYTICS.SALES."sales_summary_v"
WHERE BU_ENTITY IN ('155', '310', '165')
    AND DATE_TRUNC('month', TRX_DATE) < '2020-01-01'
    AND TYPE IN ('INV', 'CM', 'DM')
GROUP BY 
	ALL 
UNION
--after 2020
(SELECT 
    DEPARTMENT,
    BU_ENTITY,
    DEPARTMENT || '_' || BU_ENTITY AS "DEP_ENT",
	DATE_TRUNC('month', TRX_DATE) AS "MONTH", 
	SUM(NET_SALES) AS "NET_SALES"
FROM ANALYTICS.SALES."sales_summary_v"
WHERE BU_ENTITY IN ('155', '310', '165')
    AND DATE_TRUNC('month', TRX_DATE) >= '2020-01-01'
    AND (ITEM_NUMBER != '071591' OR ITEM_NUMBER IS NULL) --TEMP: REMOVE PORTABLE COLF FOAMER (STARBUCKS)
GROUP BY 
	ALL) )
SELECT *
FROM T1 
-- dep-ent combinations with budget
WHERE DEP_ENT IN (
    '160_155',
    '170_155',
    '200_155',
    '200_310',
    '210_155',
    '210_165',
    '210_310',
    '220_155',
    '220_310',
    '240_155',
    '250_155',
    '250_165',
    '250_310',
    '260_155'
) AND MONTH >= '2016-01-01'